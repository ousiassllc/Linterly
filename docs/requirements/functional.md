# 機能要件

## 1. 概要

Linterly は、ソースコードの行数が設定ファイルで定義されたルールに準拠しているかをチェックする CLI ツールである。ファイル単位・ディレクトリ単位での行数上限を設定でき、違反レベルに応じて error / warn を出力する。

## 2. ユースケース

### UC-1: プロジェクトのコード量チェック

- **アクター**: 開発者
- **概要**: プロジェクトルートで `linterly check` を実行し、設定ファイルのルールに違反するファイル・ディレクトリを検出する
- **前提条件**: `.linterly.yml` が存在する
- **正常フロー**:
  1. ユーザーが `linterly check` を実行する
  2. Linterly が設定ファイルを読み込む
  3. 対象ファイル・ディレクトリを走査する（除外ルール適用済み）
  4. 各ルールに対して行数をチェックする
  5. 結果を出力する（text または JSON）
  6. 違反レベルに応じた終了コードで終了する

### UC-2: 設定ファイルの初期化

- **アクター**: 開発者
- **概要**: `linterly init` でプロジェクトに `.linterly.yml` を生成する
- **正常フロー**:
  1. ユーザーが `linterly init` を実行する
  2. デフォルト値が入った `.linterly.yml` が生成される
  3. 既にファイルが存在する場合は上書き確認を行う

### UC-3: CI パイプラインでの自動チェック

- **アクター**: CI システム
- **概要**: CI 上で `linterly check --format json` を実行し、結果を解析する
- **正常フロー**:
  1. CI が `linterly check` を実行する
  2. error がある場合は終了コード 1 で失敗する
  3. warn のみの場合は終了コード 0 で成功する
  4. 設定ファイル不正等の実行エラーは終了コード 2 で失敗する

### UC-4: 特定ディレクトリのチェック

- **アクター**: 開発者
- **概要**: 特定のパスだけをチェックする
- **正常フロー**:
  1. ユーザーが `linterly check ./src` を実行する
  2. 指定パス配下のみを対象にチェックする

## 3. 機能一覧

### 3.1 コア機能

| ID | 機能名 | 説明 |
|----|--------|------|
| F-001 | ファイル行数チェック | ファイルごとの行数が上限を超えていないかチェックする（デフォルト上限: 400行） |
| F-002 | ディレクトリ行数チェック | ディレクトリ直下のファイルの合計行数が上限を超えていないかチェックする（サブディレクトリ内のファイルは除外、デフォルト上限: 2,000行） |
| F-003 | 違反レベル判定 | 超過率に基づき error / warn を判定する（閾値はデフォルト 10%、設定で変更可能） |
| F-004 | 行数カウントモード | 全行数（デフォルト）またはコード行数（コメント・空行除外）を設定で切替可能 |

### 3.2 設定・除外機能

| ID | 機能名 | 説明 |
|----|--------|------|
| F-010 | 設定ファイル読み込み | `.linterly.yml` からルール・設定を読み込む |
| F-011 | ignore ファイル | `.linterlyignore` でファイル・ディレクトリを除外する（gitignore 形式） |
| F-012 | ignore 優先ルール | `.linterlyignore` が存在する場合はそちらを参照し、設定ファイルの `ignore` は無視する |
| F-013 | ignore 重複警告 | `.linterlyignore` と設定ファイルの `ignore` が両方存在する場合は warn を出力する |
| F-014 | デフォルト除外 | `node_modules/` 等の一般的なパスをデフォルトで除外する |
| F-015 | デフォルト除外の無効化 | 設定ファイルの専用パラメータ（`default_excludes: false`）でデフォルト除外を無効化できる |

### 3.3 多言語対応（コメント・空行除外時）

| ID | 機能名 | 説明 |
|----|--------|------|
| F-020 | Go コメント認識 | `//` および `/* */` をコメントとして認識する |
| F-021 | Rust コメント認識 | `//` および `/* */` をコメントとして認識する |
| F-022 | JavaScript/TypeScript コメント認識 | `//` および `/* */` をコメントとして認識する |
| F-023 | Python コメント認識 | `#` をコメントとして認識する。`""" """` / `''' '''`（docstring）はブロックコメントとして扱う（位置に関わらずコード行数から除外） |
| F-024 | Ruby コメント認識 | `#` および `=begin =end` をコメントとして認識する |
| F-025 | Java/Kotlin コメント認識 | `//` および `/* */` をコメントとして認識する |
| F-026 | C/C++ コメント認識 | `//` および `/* */` をコメントとして認識する |
| F-027 | HTML/XML コメント認識 | `<!-- -->` をコメントとして認識する |
| F-028 | CSS/SCSS コメント認識 | `//` および `/* */` をコメントとして認識する |
| F-029 | Shell スクリプトコメント認識 | `#` をコメントとして認識する |
| F-030 | 言語自動検出 | ファイル拡張子から対応言語を自動判定する |

### 3.4 CLI 機能

| ID | 機能名 | 説明 |
|----|--------|------|
| F-040 | check コマンド | コード量チェックを実行する。テキスト出力では violation（warn/error）のみ表示し、pass は表示しない |
| F-041 | init コマンド | 設定ファイルを初期化する |
| F-042 | help 表示 | `linterly`（引数なし）でヘルプを表示する |
| F-043 | JSON 出力 | `--format json` で結果を JSON 形式で出力する（JSON には pass を含む全結果を出力） |
| F-044 | 設定ファイル指定 | `--config` で設定ファイルパスを指定できる |
| F-045 | 出力言語切替 | 設定ファイルの `language` で出力メッセージを日本語/英語に切替可能（デフォルト: 英語） |
| F-046 | version コマンド | バージョン情報を表示する |

### 3.5 デフォルト除外リスト

以下のパスはデフォルトで除外される。`default_excludes: false` で無効化可能。

| カテゴリ | パス |
|---------|------|
| **共通** | |
| Git 管理 | `.git/` |
| ビルド成果物 | `dist/`, `build/`, `out/` |
| minified ファイル | `*.min.js`, `*.min.css` |
| ロックファイル | `*.lock`, `*-lock.*` |
| 自動生成ファイル | `*.gen.*`, `*.generated.*` |
| IDE / AI ツール | `.idea/`, `.vscode/`, `.claude/`, `.cursor/`, `.gemini/` |
| キャッシュ | `.cache/` |
| **JavaScript/TypeScript** | |
| 依存 | `node_modules/`, `bower_components/` |
| フレームワーク | `.next/`, `.nuxt/`, `.svelte-kit/`, `.angular/` |
| ビルドツール | `.turbo/`, `.parcel-cache/`, `.vite/` |
| テストカバレッジ | `coverage/` |
| **Go** | |
| 依存 | `vendor/` |
| ORM 自動生成 | `ent/` |
| **Rust** | |
| ビルド | `target/` |
| **Python** | |
| キャッシュ | `__pycache__/`, `*.pyc`, `*.pyo` |
| 仮想環境 | `.venv/`, `venv/`, `env/` |
| パッケージ | `*.egg-info/`, `.eggs/` |
| ツールキャッシュ | `.mypy_cache/`, `.pytest_cache/`, `.tox/` |

## 4. 違反レベル判定ロジック

```
設定値: max_lines = N
閾値:   warning_threshold = T% (デフォルト: 10)

実際の行数 L に対して:
  L <= N           → pass
  N < L <= N×(1+T/100) → warn  (終了コード 0)
  L > N×(1+T/100)     → error (終了コード 1)
```

**例**: `max_lines_per_file: 400`, `warning_threshold: 10` の場合

| 行数 | 判定 | 理由 |
|------|------|------|
| 380 | pass | 400 以下 |
| 430 | warn | 400 超だが 440（+10%）以下 |
| 450 | error | 440（+10%）を超過 |

## 5. ignore 優先ルール

```
.linterlyignore が存在する？
  ├─ YES → .linterlyignore を使用
  │        └─ 設定ファイルにも ignore がある？
  │             ├─ YES → warn「.linterlyignore が優先されます。設定ファイルの ignore は無視されます」
  │             └─ NO  → そのまま続行
  └─ NO  → 設定ファイルの ignore を使用
           └─ ignore 未設定 → 除外なし（デフォルト除外のみ）
```

## 改訂履歴

| 版 | 日付 | 変更内容 | 変更理由 |
|---|------|---------|---------|
| 1.0 | 2026-02-08 | 初版作成 | — |
| 1.1 | 2026-02-08 | デフォルト除外リストを拡充（JS/Go/Rust/Python の一般的なパス、IDE/AIツールを網羅） | 各言語エコシステム・開発ツールのカバレッジ向上 |
| 1.2 | 2026-02-08 | CLI 機能に F-046 version コマンドを追加 | CLI 仕様との整合性確保 |
| 1.3 | 2026-02-08 | デフォルト値の明記、終了コード2の追加、用語統一（コード行数）、pass非表示の明記、Python docstring の扱いを明確化、例示の数値を400に統一 | 整合性チェックによる改善 |
